<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>F.O.M. ‚ù§Ô∏è</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #ffb6c1;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      border: 3px solid #ff4d6d;
      border-radius: 12px;
      box-shadow: 0 0 18px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
<script>
let personagemSelecionado = null;

/* ================= MENU ================= */
class Menu extends Phaser.Scene {
  constructor(){ super({ key:'Menu' }); }
  preload(){
    this.load.image('fundo_menu', 'imagens/fundo_menu.png');
    this.load.image('fundo_escolha', 'imagens/fundo_escolha.png');
  }
  create(){
    if (this.textures.exists('fundo_menu')) {
      this.add.image(800, 450, 'fundo_menu').setDisplaySize(1600,900);
    } else {
      this.add.rectangle(800, 450, 1600, 900, 0xcfd8dc);
    }
    this.add.text(800, 220, "First of Many ‚ù§Ô∏è", { fontSize:'64px', fill:'#000' }).setOrigin(0.5);
    const start = this.add.text(800, 520, "‚ñ∂ Come√ßar", { fontSize:'48px', fill:'#000' })
      .setOrigin(0.5).setInteractive();
    start.on('pointerdown', () => this.scene.start('EscolhaPersonagem'));

    const controls = this.add.text(800, 610, "‚öôÔ∏è Controles", { fontSize:'40px', fill:'#000' })
      .setOrigin(0.5).setInteractive();
    controls.on('pointerdown', () => {
      const bg = this.add.rectangle(800, 450, 740, 380, 0xffffff, 0.96).setStrokeStyle(4, 0x333333);
      const t1 = this.add.text(800, 340, "Controles", { fontSize:'48px', fill:'#000' }).setOrigin(0.5);
      const t2 = this.add.text(
        800, 450,
        "‚Üê ‚Üí  ou  A D : Andar\n‚Üë  ou  W  ou  ESPA√áO : Pular\nP : Pular fase (dev)\nMate inimigos caindo na cabe√ßa",
        { fontSize:'30px', fill:'#000', align:'center' }
      ).setOrigin(0.5);
      const fechar = this.add.text(800, 560, "Fechar", { fontSize:'36px', fill:'#000' })
        .setOrigin(0.5).setInteractive();
      fechar.on('pointerdown', () => { bg.destroy(); t1.destroy(); t2.destroy(); fechar.destroy(); });
    });
  }
}

/* ========== ESCOLHA PERSONAGEM ========== */
class EscolhaPersonagem extends Phaser.Scene {
  constructor(){ super({ key:'EscolhaPersonagem' }); }
  preload(){
    this.load.image('imgGabriel', 'imagens/gabriel.png');
    this.load.image('imgThaina',  'imagens/thaina.png');
  }
  create(){
    if (this.textures.exists('fundo_escolha')) {
      this.add.image(800, 450, 'fundo_escolha').setDisplaySize(1600,900);
    } else {
      this.add.rectangle(800, 450, 1600, 900, 0xcfd8dc);
    }

    this.add.text(800, 120, "Escolha seu personagem", { fontSize:'56px', fill:'#000' }).setOrigin(0.5);
    this.add.image(600, 360, 'imgGabriel').setScale(1.5);
    const btnG = this.add.text(600, 560, "üë¶ Gabriel", { fontSize:'48px', fill:'#000' })
      .setOrigin(0.5).setInteractive();
    this.add.image(1000, 360, 'imgThaina').setScale(1.5);
    const btnT = this.add.text(1000, 560, "üë© Thain√°", { fontSize:'48px', fill:'#000' })
      .setOrigin(0.5).setInteractive();

    const iniciarCom = (p) => { personagemSelecionado = p; this.scene.start('Fase0'); };
    btnG.on('pointerdown', () => iniciarCom('gabriel'));
    btnT.on('pointerdown', () => iniciarCom('thaina'));
  }
}

/* ================= BASE DAS FASES ================= */
class BaseFase extends Phaser.Scene {
  constructor(key, proximaFase, mensagem, plataformasCfg, quadroPos, inimigosCfg=[], fundoKey=null){
    super({ key });
    this.proximaFase = proximaFase;
    this.mensagem = mensagem;
    this.plataformasCfg = plataformasCfg;
    this.quadroPos = quadroPos;
    this.inimigosCfg = inimigosCfg;
    this.fundoKey = fundoKey;
  }

  preload(){
    this.load.image('chao', 'imagens/rpgTile133.png');
    this.load.spritesheet('gabrielSprite','imagens/gabrielSprite.png',{frameWidth:31,frameHeight:42});
    this.load.spritesheet('thainaSprite','imagens/thainaSprite.png',{frameWidth:31,frameHeight:42});
    this.load.image('quadro', 'imagens/quadro.png');
    this.load.image('fundoDefault', 'imagens/fundoDefault.png');
    for (let i=0; i<=13; i++) { this.load.image('fundo'+i, 'imagens/fundo'+i+'.png'); }
    this.load.image('fundoFinal', 'imagens/fundoFinal.png');
    this.load.image('enemy1', 'https://labs.phaser.io/assets/sprites/baddie.png');
  }

  create(){
    const key = this.fundoKey && this.textures.exists(this.fundoKey) ? this.fundoKey
               : (this.textures.exists('fundoDefault') ? 'fundoDefault' : null);
    if (key) this.add.image(800, 450, key).setDisplaySize(1600,900);
    else     this.add.rectangle(800, 450, 1600, 900, 0xcfd8dc);

    const tileW = this.textures.get('chao').getSourceImage().width;
    const startX = tileW / 2;
    const tilesNec = Math.ceil(1600 / tileW) + 1;
    this.plataformas = this.physics.add.staticGroup();
    const addBar = (xLeftCenter, y, w) => { for (let i=0;i<w;i++){ this.plataformas.create(xLeftCenter+i*tileW,y,'chao').refreshBody(); } };
    addBar(startX, 880, tilesNec);
    this.plataformasCfg.forEach(p => addBar(p.x, p.y, p.w));

    const spriteKey = (personagemSelecionado==='gabriel') ? 'gabrielSprite' : 'thainaSprite';
    this.player = this.physics.add.sprite(100, 720, spriteKey).setScale(2.3);
    this.player.setCollideWorldBounds(true);
    this.physics.add.collider(this.player, this.plataformas);

    if(!this.anims.exists('left_'+spriteKey)){
      this.anims.create({ key:'left_'+spriteKey,  frames:this.anims.generateFrameNumbers(spriteKey,{start:0,end:3}), frameRate:10, repeat:-1 });
      this.anims.create({ key:'turn_'+spriteKey,  frames:[{ key:spriteKey, frame:4 }], frameRate:20 });
      this.anims.create({ key:'right_'+spriteKey, frames:this.anims.generateFrameNumbers(spriteKey,{start:5,end:8}), frameRate:10, repeat:-1 });
    }

    this.cursors = this.input.keyboard.createCursorKeys();
    this.keys = this.input.keyboard.addKeys({
      up:Phaser.Input.Keyboard.KeyCodes.W,
      left:Phaser.Input.Keyboard.KeyCodes.A,
      right:Phaser.Input.Keyboard.KeyCodes.D,
      space:Phaser.Input.Keyboard.KeyCodes.SPACE,
      skip:Phaser.Input.Keyboard.KeyCodes.P
    });

    // ==== controles touch (s√≥ em mobile) ====
    this.moveLeft = this.moveRight = this.jumpPressed = false;
    if (!this.sys.game.device.os.desktop){
      const btnLeft = this.add.rectangle(120, 780, 200, 200, 0x000000, 0.2).setInteractive();
      const btnRight= this.add.rectangle(400, 780, 200, 200, 0x000000, 0.2).setInteractive();
      const btnJump = this.add.rectangle(1450, 780, 200, 200, 0x000000, 0.2).setInteractive();
      btnLeft.on('pointerdown',()=>this.moveLeft=true); btnLeft.on('pointerup',()=>this.moveLeft=false); btnLeft.on('pointerout',()=>this.moveLeft=false);
      btnRight.on('pointerdown',()=>this.moveRight=true); btnRight.on('pointerup',()=>this.moveRight=false); btnRight.on('pointerout',()=>this.moveRight=false);
      btnJump.on('pointerdown',()=>this.jumpPressed=true); btnJump.on('pointerup',()=>this.jumpPressed=false); btnJump.on('pointerout',()=>this.jumpPressed=false);
    }

    this.quadro = this.physics.add.staticSprite(this.quadroPos.x,this.quadroPos.y,'quadro').setScale(0.9);
    this.physics.add.overlap(this.player,this.quadro,this.coletarQuadro,null,this);
    this.tweens.add({ targets:this.quadro, y:this.quadro.y-15, duration:1500, yoyo:true, repeat:-1, ease:'Sine.easeInOut' });

    this.add.text(16,16,this.mensagem,{fontSize:'28px',fill:'#000'});
  }

  update(){
    const left  = this.cursors.left.isDown  || this.keys.left.isDown  || this.moveLeft;
    const right = this.cursors.right.isDown || this.keys.right.isDown || this.moveRight;
    const jump  = this.cursors.up.isDown || this.keys.up.isDown || this.keys.space.isDown || this.jumpPressed;
    const spriteKey = (personagemSelecionado==='gabriel') ? 'gabrielSprite' : 'thainaSprite';

    if (left){ this.player.setVelocityX(-200); this.player.anims.play('left_'+spriteKey,true); }
    else if (right){ this.player.setVelocityX(200); this.player.anims.play('right_'+spriteKey,true); }
    else { this.player.setVelocityX(0); this.player.anims.play('turn_'+spriteKey); }
    if (jump && this.player.body.blocked.down){ this.player.setVelocityY(-600); }

    if (Phaser.Input.Keyboard.JustDown(this.keys.skip)) {
      if (this.proximaFase) this.scene.start(this.proximaFase);
      else this.scene.start('Menu');
    }
  }
  coletarQuadro(){ if (this.proximaFase) this.scene.start(this.proximaFase); else this.scene.start('Menu'); }
}

/* ========== FASES EXEMPLO (adicione suas configs completas aqui) ========== */
class Fase0 extends BaseFase {
  constructor(){ super("Fase0","Fase1","Fase 0 ‚ù§Ô∏è",[ {x:300,y:760,w:4} ],{x:1180,y:500},[],'fundo0'); }
}
class Fase1 extends BaseFase {
  constructor(){ super("Fase1","Fase2","Fase 1 ‚ù§Ô∏è",[ {x:400,y:720,w:4} ],{x:1260,y:440},[],'fundo1'); }
}
class Fase2 extends BaseFase {
  constructor(){ super("Fase2","Fase3","Fase 2 ‚ù§Ô∏è",[ {x:320,y:720,w:3} ],{x:1330,y:320},[],'fundo2'); }
}
class Fase3 extends BaseFase {
  constructor(){ super("Fase3",null,"Fase 3 ‚ù§Ô∏è",[ {x:300,y:720,w:3} ],{x:1360,y:460},[],'fundo3'); }
}

/* ================= CONFIG ================= */
const config = {
  type: Phaser.AUTO,
  width: 1600,
  height: 900,
  pixelArt:true,
  physics: { default:'arcade', arcade:{ gravity:{ y:600 }, debug:false } },
  scene: [Menu, EscolhaPersonagem, Fase0, Fase1, Fase2, Fase3]
};
new Phaser.Game(config);
</script>
</body>
</html>
