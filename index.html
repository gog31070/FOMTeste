<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>F.O.M. ‚ù§Ô∏è</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #ffb6c1;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      border: 3px solid #ff4d6d;
      border-radius: 12px;
      box-shadow: 0 0 18px rgba(0,0,0,.35);
    }
  </style>
</head>
<body>
<script>
let personagemSelecionado = null;

/* ================= MENU ================= */
class Menu extends Phaser.Scene {
  constructor(){ super({ key:'Menu' }); }
  preload(){
    // fundos opcionais do menu/controles (se n√£o existirem, tudo bem)
    this.load.image('fundo_menu', 'imagens/fundo_menu.png');
    this.load.image('fundo_escolha', 'imagens/fundo_escolha.png');
  }
  create(){
    // tenta usar imagem de fundo; se n√£o existir, usa cor s√≥lida
    if (this.textures.exists('fundo_menu')) {
      this.add.image(800, 450, 'fundo_menu').setDisplaySize(1600,900);
    } else {
      this.add.rectangle(800, 450, 1600, 900, 0xcfd8dc);
    }

    this.add.text(800, 220, "First of Many ‚ù§Ô∏è", { fontSize:'64px', fill:'#000' }).setOrigin(0.5);

    const start = this.add.text(800, 520, "‚ñ∂ Come√ßar", { fontSize:'48px', fill:'#000' })
      .setOrigin(0.5).setInteractive();
    start.on('pointerdown', () => this.scene.start('EscolhaPersonagem'));

    const controls = this.add.text(800, 610, "‚öôÔ∏è Controles", { fontSize:'40px', fill:'#000' })
      .setOrigin(0.5).setInteractive();
    controls.on('pointerdown', () => {
      const bg = this.add.rectangle(800, 450, 740, 380, 0xffffff, 0.96).setStrokeStyle(4, 0x333333);
      const t1 = this.add.text(800, 340, "Controles", { fontSize:'48px', fill:'#000' }).setOrigin(0.5);
      const t2 = this.add.text(
        800, 450,
        "‚Üê ‚Üí  ou  A D : Andar\n‚Üë  ou  W  ou  ESPA√áO : Pular\n\nMate inimigos caindo na cabe√ßa",
        { fontSize:'30px', fill:'#000', align:'center' }
      ).setOrigin(0.5);
      const fechar = this.add.text(800, 560, "Fechar", { fontSize:'36px', fill:'#000' })
        .setOrigin(0.5).setInteractive();
      fechar.on('pointerdown', () => { bg.destroy(); t1.destroy(); t2.destroy(); fechar.destroy(); });
    });
  }
}

/* ========== ESCOLHA PERSONAGEM ========== */
class EscolhaPersonagem extends Phaser.Scene {
  constructor(){ super({ key:'EscolhaPersonagem' }); }
  preload(){
    this.load.image('imgGabriel', 'imagens/gabriel.png');
    this.load.image('imgThaina',  'imagens/thaina.png');
    // fundo opcional desta cena
    if (!this.textures.exists('fundo_escolha')) this.load.image('fundo_escolha', 'imagens/fundo_escolha.png');
  }
  create(){
    if (this.textures.exists('fundo_escolha')) {
      this.add.image(800, 450, 'fundo_escolha').setDisplaySize(1600,900);
    } else {
      this.add.rectangle(800, 450, 1600, 900, 0xcfd8dc);
    }

    this.add.text(800, 120, "Escolha seu personagem", { fontSize:'56px', fill:'#000' }).setOrigin(0.5);

    this.add.image(600, 360, 'imgGabriel').setScale(1.5);
    const btnG = this.add.text(600, 560, "üë¶ Gabriel", { fontSize:'48px', fill:'#000' })
      .setOrigin(0.5).setInteractive();

    this.add.image(1000, 360, 'imgThaina').setScale(1.5);
    const btnT = this.add.text(1000, 560, "üë© Thain√°", { fontSize:'48px', fill:'#000' })
      .setOrigin(0.5).setInteractive();

    const iniciarCom = (p) => {
      personagemSelecionado = p;
      this.scene.start('Fase0');
    };
    btnG.on('pointerdown', () => iniciarCom('gabriel'));
    btnT.on('pointerdown', () => iniciarCom('thaina'));
  }
}

/* ================= BASE DAS FASES ================= */
class BaseFase extends Phaser.Scene {
  constructor(key, proximaFase, mensagem, plataformasCfg, quadroPos, inimigosCfg=[], fundoKey=null){
    super({ key });
    this.proximaFase = proximaFase;
    this.mensagem = mensagem;
    this.plataformasCfg = plataformasCfg; // [{x,y,w}]
    this.quadroPos = quadroPos;
    this.inimigosCfg = inimigosCfg;       // [{x,y,dir,key, xMin?, xMax?, speed?}]
    this.fundoKey = fundoKey;             // string com a key do fundo (ex: 'fundo7')
  }

  preload(){
    // ch√£o (da pasta)
    this.load.image('chao', 'imagens/rpgTile133.png');

    // spritesheets do jogador (da pasta)
    this.load.spritesheet('gabrielSprite', 'imagens/gabrielSprite.png', {
  frameWidth: 31,
  frameHeight: 42
});
    this.load.spritesheet('thainaSprite', 'imagens/thainaSprite.png', {
  frameWidth: 31,
  frameHeight: 42
});
    // quadro (da pasta)
    this.load.image('quadro', 'imagens/quadro.png');

    // fundos opcionais (fallback + nomes padr√£o por fase)
    this.load.image('fundoDefault', 'imagens/fundoDefault.png'); // opcional, se n√£o existir usa cor s√≥lida
    // Se voc√™ quiser usar arquivos por fase (ex.: fundo0.png, ...), coloque-os e descomente:
    for (let i=0; i<=13; i++) {
      this.load.image('fundo'+i, 'imagens/fundo'+i+'.png');
    }
    this.load.image('fundoFinal', 'imagens/fundoFinal.png');

    // inimigos placeholders + op√ß√µes locais
    this.load.image('enemy1', 'https://labs.phaser.io/assets/sprites/baddie.png');
    this.load.image('enemy2', 'https://labs.phaser.io/assets/sprites/red_ball.png');
    this.load.image('enemy3', 'https://labs.phaser.io/assets/sprites/yellow_ball.png');
    this.load.image('enemyLocal1', 'imagens/enemy1.png'); // se existir
    this.load.image('enemyLocal2', 'imagens/enemy2.png'); // se existir
    this.load.image('enemyLocal3', 'imagens/enemy3.png'); // se existir
  }

  create(){
    // ===== Fundo por imagem (se existir) ou cor s√≥lida =====
    const key = this.fundoKey && this.textures.exists(this.fundoKey) ? this.fundoKey
               : (this.textures.exists('fundoDefault') ? 'fundoDefault' : null);
    if (key) this.add.image(800, 450, key).setDisplaySize(1600,900);
    else     this.add.rectangle(800, 450, 1600, 900, 0xcfd8dc);

    // ===== plataformas: ch√£o completo + extras =====
    const tileW = this.textures.get('chao').getSourceImage().width;
    const startX = tileW / 2;                           // evita ‚Äúfuro‚Äù √† esquerda
    const tilesNec = Math.ceil(1600 / tileW) + 1;

    this.plataformas = this.physics.add.staticGroup();

    const addBar = (xLeftCenter, y, w) => {
      for (let i=0; i<w; i++){
        this.plataformas.create(xLeftCenter + i*tileW, y, 'chao').refreshBody();
      }
    };

    // ch√£o inteiro na base
    addBar(startX, 880, tilesNec);

    // barras extras da fase
    this.plataformasCfg.forEach(p => addBar(p.x, p.y, p.w));

    // ===== jogador =====
    const spriteKey = (personagemSelecionado === 'gabriel') ? 'gabrielSprite' : 'thainaSprite';
    this.player = this.physics.add.sprite(100, 720, spriteKey).setScale(2.3);
    this.player.setCollideWorldBounds(true);
    this.physics.add.collider(this.player, this.plataformas);

    if(!this.anims.exists('left_'+spriteKey)){
      this.anims.create({ key:'left_'+spriteKey,  frames:this.anims.generateFrameNumbers(spriteKey,{start:0,end:3}), frameRate:10, repeat:-1 });
      this.anims.create({ key:'turn_'+spriteKey,  frames:[{ key:spriteKey, frame:4 }], frameRate:20 });
      this.anims.create({ key:'right_'+spriteKey, frames:this.anims.generateFrameNumbers(spriteKey,{start:5,end:8}), frameRate:10, repeat:-1 });
    }

    this.cursors = this.input.keyboard.createCursorKeys();
    this.keys = this.input.keyboard.addKeys({
      up: Phaser.Input.Keyboard.KeyCodes.W,
      left: Phaser.Input.Keyboard.KeyCodes.A,
      right: Phaser.Input.Keyboard.KeyCodes.D,
      space: Phaser.Input.Keyboard.KeyCodes.SPACE,
      skip: Phaser.Input.Keyboard.KeyCodes.P
    });

    // ===== quadro flutuando =====
    this.quadro = this.physics.add.staticSprite(this.quadroPos.x, this.quadroPos.y, 'quadro').setScale(0.9);
    this.physics.add.overlap(this.player, this.quadro, this.coletarQuadro, null, this);
    this.tweens.add({ targets:this.quadro, y:this.quadro.y-15, duration:1500, yoyo:true, repeat:-1, ease:'Sine.easeInOut' });

    // label fase
    this.add.text(16, 16, this.mensagem, { fontSize:'28px', fill:'#000' });

    // ===== inimigos (isolados por fase) + sensor antiborda =====
    this.inimigos = this.physics.add.group();
    this.inimigosCfg.forEach(cfg => {
      const eKey = cfg.key || 'enemy1';
      const scale = eKey.startsWith('enemyLocal') ? 1 : 2;
      const e = this.inimigos.create(cfg.x, cfg.y, eKey).setScale(scale);
      e.setCollideWorldBounds(true);

      const dir = (cfg.dir || -1);            // -1 = esquerda, 1 = direita
      const speed = Math.abs(cfg.speed || 100);
      e.setVelocityX(dir * speed);

      // limites opcionais
      e.patrol = { xMin: cfg.xMin ?? null, xMax: cfg.xMax ?? null };

      // sensor de borda √† frente do inimigo (invis√≠vel)
      const aheadX = e.x + dir * (e.displayWidth/2 + 6);
      const aheadY = e.y + e.displayHeight/2 + 2;
      e.edgeProbe = this.add.rectangle(aheadX, aheadY, 4, 4, 0x00ff00, 0);
      this.physics.add.existing(e.edgeProbe);
      e.edgeProbe.body.setAllowGravity(false);
      e.edgeProbe.body.setImmovable(true);

      this.physics.add.collider(e, this.plataformas);
    });

    // colis√£o jogador <-> inimigos (morre)
    this.physics.add.collider(this.player, this.inimigos, this.playerHit, null, this);

    // sensor de stomp (mata se cair em cima)
    this.playerFoot = this.add.rectangle(
      this.player.x,
      this.player.y + this.player.displayHeight/2 + 10,
      this.player.displayWidth * 0.7,
      16, 0x00ff00, 0
    );
    this.physics.add.existing(this.playerFoot);
    this.playerFoot.body.setAllowGravity(false);
    this.playerFoot.body.setImmovable(true);
    this.physics.add.overlap(this.playerFoot, this.inimigos, this.playerStomp, null, this);
  }

  update(){
    // movimento jogador
    const left  = this.cursors.left.isDown  || this.keys.left.isDown;
    const right = this.cursors.right.isDown || this.keys.right.isDown;
    const jump  = (this.cursors.up.isDown || this.keys.up.isDown || this.keys.space.isDown);
    const spriteKey = (personagemSelecionado === 'gabriel') ? 'gabrielSprite' : 'thainaSprite';

    if (left){  this.player.setVelocityX(-200); this.player.anims.play('left_'+spriteKey, true); }
    else if (right){ this.player.setVelocityX(200); this.player.anims.play('right_'+spriteKey, true); }
    else { this.player.setVelocityX(0); this.player.anims.play('turn_'+spriteKey); }

    if (jump && this.player.body.blocked.down){ this.player.setVelocityY(-600); }

    // atualizar posi√ß√£o do sensor do jogador
    this.playerFoot.x = this.player.x;
    this.playerFoot.y = this.player.y + (this.player.displayHeight/2) + 10;
    this.playerFoot.body.updateFromGameObject();

    // ===== inimigos: antiborda universal + colis√£o lateral + limites =====
    this.inimigos.children.iterate(e => {
      if (!e || !e.body) return;

      const curVx = e.body.velocity.x || -100;
      const dir = Math.sign(curVx) || -1;

      // reposiciona o sensor √† frente dos p√©s
      const aheadX = e.x + dir * (e.displayWidth/2 + 6);
      const aheadY = e.y + e.displayHeight/2 + 2;

      if (!e.edgeProbe) {
        e.edgeProbe = this.add.rectangle(aheadX, aheadY, 4, 4, 0x00ff00, 0);
        this.physics.add.existing(e.edgeProbe);
        e.edgeProbe.body.setAllowGravity(false);
        e.edgeProbe.body.setImmovable(true);
      }
      e.edgeProbe.x = aheadX;
      e.edgeProbe.y = aheadY;
      e.edgeProbe.body.updateFromGameObject();

      // h√° ch√£o √† frente?
      let groundAhead = false;
      this.physics.overlap(e.edgeProbe, this.plataformas, () => { groundAhead = true; });

      // sem ch√£o: vira
      if (!groundAhead) {
        const v = Math.max(60, Math.abs(curVx));
        e.setVelocityX(-dir * v);
      }

      // parede: vira
      if (e.body.blocked.right) e.setVelocityX(-Math.abs(e.body.velocity.x));
      if (e.body.blocked.left)  e.setVelocityX( Math.abs(e.body.velocity.x));

      // limites xMin/xMax, se definidos
      if (e.patrol) {
        const v = Math.max(60, Math.abs(e.body.velocity.x) || 100);
        if (e.patrol.xMin != null && e.x <= e.patrol.xMin) e.setVelocityX( v);
        if (e.patrol.xMax != null && e.x >= e.patrol.xMax) e.setVelocityX(-v);
      }
    });

    // tecla P: pular de fase
    if (Phaser.Input.Keyboard.JustDown(this.keys.skip)) {
      if (this.proximaFase) this.scene.start(this.proximaFase);
      else this.scene.start('Menu');
    }
  }

  coletarQuadro(){ if (this.proximaFase) this.scene.start(this.proximaFase); else this.scene.start('Menu'); }
  playerHit(){ this.scene.restart(); }
  playerStomp(foot, enemy){
    if (this.player.body.velocity.y > 0 && enemy.active){
      enemy.disableBody(true, true);
      this.player.setVelocityY(-400);
    }
  }
}

/* ================= FASES (plataformas + inimigos + fundoKey) =================
   Dica: Coloque 'imagens/fundo0.png'...'fundo13.png' e passe 'fundoX' na fase.
*/

/* F√°ceis: 0‚Äì2 (sem inimigo) */
class Fase0 extends BaseFase {
  constructor(){
    super("Fase0","Fase1","Fase 0: O come√ßo ‚ù§Ô∏è",
      [ {x:300,y:760,w:4},{x:720,y:660,w:3},{x:1080,y:560,w:2} ],
      {x:1180,y:500},
      [],
      'fundo0'
    );
  }
}
class Fase1 extends BaseFase {
  constructor(){
    super("Fase1","Fase2","Fase 1: Aquecendo ‚ù§Ô∏è",
      [ {x:420,y:720,w:4},{x:820,y:600,w:3},{x:1200,y:500,w:2} ],
      {x:1260,y:440},
      [],
      'fundo1'
    );
  }
}
class Fase2 extends BaseFase {
  constructor(){
    super("Fase2","Fase3","Fase 2: Primeiros pulos ‚ù§Ô∏è",
      [ {x:320,y:720,w:3},{x:640,y:600,w:3},{x:960,y:480,w:3},{x:1280,y:380,w:2} ],
      {x:1330,y:320},
      [],
      'fundo2'
    );
  }
}

/* M√©dias: 3‚Äì8 (1 inimigo) */
class Fase3 extends BaseFase {
  constructor(){
    super("Fase3","Fase4","Fase 3 ‚ù§Ô∏è",
      [ {x:300,y:720,w:3},{x:580,y:600,w:2},{x:820,y:520,w:2},{x:1080,y:420,w:2},{x:1320,y:520,w:2} ],
      {x:1360,y:460},
      [ {x:840,y:500, dir:-1, key:'enemy1', xMin:820, xMax:1080} ],
      'fundo3'
    );
  }
}
class Fase4 extends BaseFase {
  constructor(){
    super("Fase4","Fase5","Fase 4 ‚ù§Ô∏è",
      [ {x:500,y:740,w:3},{x:760,y:640,w:3},{x:980,y:520,w:2},{x:1240,y:420,w:2} ],
      {x:1280,y:360},
      [ {x:780,y:620, dir:-1, key:'enemy2', xMin:760, xMax:920} ],
      'fundo4'
    );
  }
}
class Fase5 extends BaseFase {
  constructor(){
    super("Fase5","Fase6","Fase 5 ‚ù§Ô∏è",
      [ {x:350,y:720,w:4},{x:780,y:560,w:3},{x:1120,y:420,w:2},{x:1360,y:520,w:2} ],
      {x:1400,y:460},
      [ {x:800,y:540, dir:-1, key:'enemy3', xMin:780, xMax:940} ],
      'fundo5'
    );
  }
}
class Fase6 extends BaseFase {
  constructor(){
    super("Fase6","Fase7","Fase 6 ‚ù§Ô∏è",
      [ {x:320,y:720,w:3},{x:640,y:600,w:3},{x:980,y:520,w:2},{x:1240,y:400,w:2},{x:1460,y:520,w:2} ],
      {x:1500,y:460},
      [ {x:660,y:580, dir:-1, key:'enemy2', xMin:640, xMax:800} ],
      'fundo6'
    );
  }
}
class Fase7 extends BaseFase {
  constructor(){
    super("Fase7","Fase8","Fase 7 ‚ù§Ô∏è",
      [ {x:280,y:740,w:3},{x:560,y:640,w:3},{x:840,y:520,w:3},{x:1120,y:420,w:2},{x:1360,y:520,w:2} ],
      {x:1400,y:460},
      [ {x:860,y:500, dir:-1, key:'enemy1', xMin:840, xMax:1000} ],
      'fundo7'
    );
  }
}
class Fase8 extends BaseFase {
  constructor(){
    super("Fase8","Fase9","Fase 8 ‚ù§Ô∏è",
      [ {x:520,y:740,w:3},{x:820,y:620,w:3},{x:1120,y:520,w:2},{x:1360,y:420,w:2} ],
      {x:1400,y:360},
      [ {x:840,y:600, dir:-1, key:'enemy3', xMin:820, xMax:980} ],
      'fundo8'
    );
  }
}

/* Dif√≠ceis: 9‚Äì12 (2 inimigos) */
class Fase9 extends BaseFase {
  constructor(){
    super("Fase9","Fase10","Fase 9 ‚ù§Ô∏è",
      [ {x:320,y:720,w:3},{x:640,y:620,w:2},{x:900,y:520,w:2},{x:1160,y:420,w:2},{x:1380,y:320,w:2} ],
      {x:1420,y:260},
      [
        {x:660,y:600, dir:-1, key:'enemy1', xMin:640, xMax:768},
        {x:920,y:500, dir:1,  key:'enemy2', xMin:900, xMax:1028}
      ],
      'fundo9'
    );
  }
}
class Fase10 extends BaseFase {
  constructor(){
    super("Fase10","Fase11","Fase 10 ‚ù§Ô∏è",
      [ {x:420,y:740,w:4},{x:880,y:600,w:3},{x:1180,y:500,w:2},{x:1380,y:380,w:2} ],
      {x:1420,y:320},
      [
        {x:900,y:580, dir:-1, key:'enemy2', xMin:880, xMax:1040},
        {x:1200,y:480,dir:1,  key:'enemy3', xMin:1180,xMax:1308}
      ],
      'fundo10'
    );
  }
}
class Fase11 extends BaseFase {
  constructor(){
    super("Fase11","Fase12","Fase 11 ‚ù§Ô∏è",
      [ {x:300,y:720,w:3},{x:620,y:600,w:2},{x:900,y:520,w:2},{x:1160,y:440,w:2},{x:1400,y:360,w:2} ],
      {x:1440,y:300},
      [
        {x:640,y:580, dir:-1, key:'enemy3', xMin:620, xMax:748},
        {x:920,y:500, dir:1,  key:'enemy1', xMin:900, xMax:1028}
      ],
      'fundo11'
    );
  }
}
class Fase12 extends BaseFase {
  constructor(){
    super("Fase12","Fase13","Fase 12 ‚ù§Ô∏è",
      [
        {x:360,y:720,w:3},{x:660,y:600,w:3},{x:960,y:480,w:3}, // caminho A
        {x:520,y:760,w:3},{x:820,y:640,w:3},{x:1120,y:520,w:2}  // caminho B
      ],
      {x:1180,y:460},
      [
        {x:680,y:580, dir:-1, key:'enemy2', xMin:660, xMax:820},
        {x:980,y:460, dir:1,  key:'enemy3', xMin:960, xMax:1088}
      ],
      'fundo12'
    );
  }
}

/* Final: 13 (sem inimigos) */
class Fase13 extends BaseFase {
  constructor(){
    super("Fase13", null, "Fase 13: Final ‚ù§Ô∏è",
      [ /* s√≥ o ch√£o autom√°tico */ ],
      {x:800, y:700},
      [],
      'fundoFinal'
    );
  }
}

/* ================= CONFIG ================= */
const config = {
  type: Phaser.AUTO,
  width: 1600,
  height: 900,
  pixelArt:true,
  physics: { default:'arcade', arcade:{ gravity:{ y:600 }, debug:false } },
  scene: [
    Menu, EscolhaPersonagem,
    Fase0, Fase1, Fase2, Fase3, Fase4, Fase5, Fase6, Fase7, Fase8,
    Fase9, Fase10, Fase11, Fase12, Fase13
  ]
};
new Phaser.Game(config);
</script>
</body>
</html>
