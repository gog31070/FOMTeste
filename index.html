<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Nosso Joguinho ❤️</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #b22222;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      border: 3px solid #ff4d6d;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.3);
    }
  </style>
</head>
<body>
<script>
class BaseFase extends Phaser.Scene {
  constructor(key, proximaFase, mensagem, plataformasCfg, quadroKey, quadroPos, inimigosCfg=[]) {
    super({ key });
    this.proximaFase = proximaFase;
    this.mensagem = mensagem;
    this.plataformasCfg = plataformasCfg;
    this.quadroKey = quadroKey;
    this.quadroPos = quadroPos;
    this.inimigosCfg = inimigosCfg; // agora pode ter vários inimigos
  }

  preload() {
    this.load.image('ground', 'rpgTile133.png');
    this.load.image('quadro', 'imagens/quadro.png');
    this.load.spritesheet('dude','https://labs.phaser.io/assets/sprites/dude.png',
      { frameWidth: 32, frameHeight: 48 }
    );
    this.load.image('enemy1', 'https://labs.phaser.io/assets/sprites/baddie.png');
    this.load.image('enemy2', 'https://labs.phaser.io/assets/sprites/robot.png');
  }

  create() {
    this.add.rectangle(800, 450, 1600, 900, 0x87ceeb);

    // plataformas
    this.plataformas = this.physics.add.staticGroup();
    this.plataformasCfg.forEach(p => {
      for (let i = 0; i < p.scaleX; i++) {
        this.plataformas.create(p.x + i * 64, p.y, 'ground').setScale(1).refreshBody();
      }
    });

    // jogador
    this.player = this.physics.add.sprite(100, 700, 'dude').setScale(2);
    this.player.setBounce(0.1);
    this.player.setCollideWorldBounds(true);
    this.physics.add.collider(this.player, this.plataformas);

    // animações
    this.anims.create({ key: 'left', frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }), frameRate: 10, repeat: -1 });
    this.anims.create({ key: 'turn', frames: [{ key: 'dude', frame: 4 }], frameRate: 20 });
    this.anims.create({ key: 'right', frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }), frameRate: 10, repeat: -1 });

    // controles teclado
    this.cursors = this.input.keyboard.createCursorKeys();
    this.keys = this.input.keyboard.addKeys({
      up: Phaser.Input.Keyboard.KeyCodes.W,
      left: Phaser.Input.Keyboard.KeyCodes.A,
      down: Phaser.Input.Keyboard.KeyCodes.S,
      right: Phaser.Input.Keyboard.KeyCodes.D,
      space: Phaser.Input.Keyboard.KeyCodes.SPACE
    });

    // quadro
    this.quadro = this.physics.add.staticSprite(this.quadroPos.x, this.quadroPos.y, this.quadroKey).setScale(1.2);
    this.tweens.add({
      targets: this.quadro,
      y: this.quadro.y - 10,
      duration: 1000,
      yoyo: true,
      repeat: -1,
      ease: 'Sine.easeInOut'
    });
    this.physics.add.overlap(this.player, this.quadro, this.coletarQuadro, null, this);

    // texto
    this.add.text(16, 16, this.mensagem, { fontSize: '28px', fill: '#000' });

    // inimigos
    this.inimigos = this.physics.add.group();
    this.inimigosCfg.forEach(cfg => {
      const enemy = this.physics.add.sprite(cfg.x, cfg.y, cfg.tipo).setScale(2);
      enemy.setCollideWorldBounds(true);
      this.physics.add.collider(enemy, this.plataformas);
      enemy.setVelocityX(cfg.direcao === 'esquerda' ? -100 : 100);

      this.inimigos.add(enemy);

      // colisão normal
      this.physics.add.collider(this.player, enemy, this.playerHit, null, this);

      // sensor de stomp
      this.playerFoot = this.add.rectangle(this.player.x,this.player.y + this.player.displayHeight/2 + 10,this.player.displayWidth*0.7,16,0x00ff00,0);
      this.physics.add.existing(this.playerFoot);
      this.playerFoot.body.setAllowGravity(false);
      this.playerFoot.body.setImmovable(true);
      this.physics.add.overlap(this.playerFoot, enemy, this.playerStomp, null, this);
    });

    // ==== mobile ====
    this.moveLeft = this.moveRight = this.jumpPressed = false;
    if (!this.sys.game.device.os.desktop){
      this.cameras.main.setZoom(1.3);

      const btnLeft = this.add.rectangle(120, 750, 180, 180, 0x000000, 0.2).setScrollFactor(0).setInteractive();
      const btnRight = this.add.rectangle(320, 750, 180, 180, 0x000000, 0.2).setScrollFactor(0).setInteractive();
      const btnJump = this.add.rectangle(1480, 750, 220, 220, 0x000000, 0.2).setScrollFactor(0).setInteractive();

      btnLeft.on('pointerdown', () => this.moveLeft = true);
      btnLeft.on('pointerup',   () => this.moveLeft = false);
      btnLeft.on('pointerout',  () => this.moveLeft = false);

      btnRight.on('pointerdown', () => this.moveRight = true);
      btnRight.on('pointerup',   () => this.moveRight = false);
      btnRight.on('pointerout',  () => this.moveRight = false);

      btnJump.on('pointerdown', () => this.jumpPressed = true);
      btnJump.on('pointerup',   () => this.jumpPressed = false);
      btnJump.on('pointerout',  () => this.jumpPressed = false);
    }
  }

  update() {
    const left  = this.cursors.left.isDown  || this.keys.left.isDown  || this.moveLeft;
    const right = this.cursors.right.isDown || this.keys.right.isDown || this.moveRight;
    const jump  = (this.cursors.up.isDown || this.keys.up.isDown || this.keys.space.isDown || this.jumpPressed);

    if (left) {
      this.player.setVelocityX(-200);
      this.player.anims.play('left', true);
    }
    else if (right) {
      this.player.setVelocityX(200);
      this.player.anims.play('right', true);
    }
    else {
      this.player.setVelocityX(0);
      this.player.anims.play('turn');
    }

    if (jump && this.player.body.blocked.down) {
      this.player.setVelocityY(-600);
    }

    // atualizar sensor
    if (this.playerFoot) {
      this.playerFoot.x = this.player.x;
      this.playerFoot.y = this.player.y + (this.player.displayHeight/2) + 10;
      this.playerFoot.body.updateFromGameObject();
    }

    // inimigos não caem e viram
    this.inimigos.children.iterate(enemy => {
      if (!enemy || !enemy.body) return;
      if (enemy.body.blocked.right) {
        enemy.setVelocityX(-100);
      } else if (enemy.body.blocked.left) {
        enemy.setVelocityX(100);
      }
    });
  }

  coletarQuadro(jogador, quadro) {
    if (this.proximaFase) this.scene.start(this.proximaFase);
    else {
      this.add.text(800, 450, 'Feliz 1 ano ❤️ Eu te amo!', { fontSize: '48px', fill: '#000' }).setOrigin(0.5);
    }
  }

  playerHit(player, enemy) {
    this.scene.restart();
  }

  playerStomp(foot, enemy) {
    if (this.player.body.velocity.y > 0 && enemy.active) {
      enemy.disableBody(true, true);
      this.player.setVelocityY(-400);
    }
  }
}

// ====== Fases ======
class Fase0 extends BaseFase { constructor(){ super("Fase0","Fase1","Fase 0: O começo ❤️",[ { x: 100, y: 880, scaleX: 25 } ],'quadro',{ x: 800, y: 700 }, []); } }
class Fase1 extends BaseFase { constructor(){ super("Fase1","Fase2","Fase 1 ❤️",[ { x: 100, y: 880, scaleX: 25 } ],'quadro',{ x: 1200, y: 700 }, []); } }
class Fase2 extends BaseFase { constructor(){ super("Fase2","Fase3","Fase 2 ❤️",[ { x: 100, y: 880, scaleX: 25 }, { x: 900, y: 600, scaleX: 5 } ],'quadro',{ x: 1300, y: 500 }, []); } }
class Fase3 extends BaseFase { constructor(){ super("Fase3","Fase4","Fase 3 ❤️",[ { x: 100, y: 880, scaleX: 25 } ],'quadro',{ x: 800, y: 700 }, [ {x: 800, y: 700, tipo:'enemy1', direcao:'esquerda'} ]); } }
// ... você pode expandir as próximas fases igual a esse esquema ...

const config = {
  type: Phaser.AUTO,
  width: 1600,
  height: 900,
  physics: { default: 'arcade', arcade: { gravity: { y: 600 }, debug: false } },
  scene: [Fase0, Fase1, Fase2, Fase3]
};
new Phaser.Game(config);
</script>
</body>
</html>
