<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>F.O.M. ‚ù§Ô∏è</title>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #ffb6c1;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    canvas {
      border: 3px solid #ff4d6d;
      border-radius: 12px;
      box-shadow: 0 0 18px rgba(0,0,0,.35);
      display: block;
      margin: auto; /* mant√©m centralizado */
    }
  </style>
</head>
<body>
<script>
let personagemSelecionado = null;
let isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

/* ================= MENU ================= */
class Menu extends Phaser.Scene {
  constructor(){ super({ key:'Menu' }); }
  preload(){
    this.load.image('fundo_menu', 'imagens/fundo_menu.png');
  }
  create(){
    if (this.textures.exists('fundo_menu')) {
      this.add.image(800, 450, 'fundo_menu').setDisplaySize(1600,900);
    } else {
      this.add.rectangle(800, 450, 1600, 900, 0xcfd8dc);
    }
    this.add.text(800, 220, "First of Many ‚ù§Ô∏è", { fontSize:'64px', fill:'#000' }).setOrigin(0.5);

    const start = this.add.text(800, 520, "‚ñ∂ Come√ßar", { fontSize:'48px', fill:'#000' })
      .setOrigin(0.5).setInteractive();
    start.on('pointerdown', () => this.scene.start('EscolhaPersonagem'));
  }
}

/* ========== ESCOLHA PERSONAGEM ========== */
class EscolhaPersonagem extends Phaser.Scene {
  constructor(){ super({ key:'EscolhaPersonagem' }); }
  preload(){
    this.load.spritesheet('gabrielSprite', 'imagens/gabrielSprite.png', { frameWidth: 31, frameHeight: 42 });
    this.load.spritesheet('thainaSprite', 'imagens/thainaSprite.png', { frameWidth: 31, frameHeight: 42 });
  }
  create(){
    this.add.text(800, 120, "Escolha seu personagem", { fontSize:'56px', fill:'#000' }).setOrigin(0.5);

    const btnG = this.add.text(600, 460, "üë¶ Gabriel", { fontSize:'48px', fill:'#000' })
      .setOrigin(0.5).setInteractive();
    const btnT = this.add.text(1000, 460, "üë© Thain√°", { fontSize:'48px', fill:'#000' })
      .setOrigin(0.5).setInteractive();

    const iniciarCom = (p) => {
      personagemSelecionado = p;
      this.scene.start('Fase0');
    };
    btnG.on('pointerdown', () => iniciarCom('gabriel'));
    btnT.on('pointerdown', () => iniciarCom('thaina'));
  }
}

/* ================= BASE DAS FASES ================= */
class BaseFase extends Phaser.Scene {
  constructor(key, proximaFase, mensagem, plataformasCfg, quadroPos, inimigosCfg=[]){
    super({ key });
    this.proximaFase = proximaFase;
    this.mensagem = mensagem;
    this.plataformasCfg = plataformasCfg;
    this.quadroPos = quadroPos;
    this.inimigosCfg = inimigosCfg;
  }

  preload(){
    this.load.image('chao', 'imagens/rpgTile133.png');
    this.load.image('quadro', 'imagens/quadro.png');
    this.load.image('enemy1', 'https://labs.phaser.io/assets/sprites/baddie.png');
  }

  create(){
    // ch√£o
    const tileW = this.textures.get('chao').getSourceImage().width;
    const startX = tileW/2;
    const tilesNec = Math.ceil(1600/tileW)+1;
    this.plataformas = this.physics.add.staticGroup();
    for (let i=0; i<tilesNec; i++){
      this.plataformas.create(startX + i*tileW, 880, 'chao').refreshBody();
    }
    this.plataformasCfg.forEach(p => {
      for (let i=0;i<p.w;i++){
        this.plataformas.create(p.x+i*tileW, p.y, 'chao').refreshBody();
      }
    });

    // jogador
    const spriteKey = personagemSelecionado==='gabriel'?'gabrielSprite':'thainaSprite';
    this.player = this.physics.add.sprite(100, 720, spriteKey).setScale(2.3);
    this.player.setCollideWorldBounds(true);
    this.physics.add.collider(this.player, this.plataformas);

    if(!this.anims.exists('left_'+spriteKey)){
      this.anims.create({ key:'left_'+spriteKey, frames:this.anims.generateFrameNumbers(spriteKey,{start:0,end:3}), frameRate:10, repeat:-1 });
      this.anims.create({ key:'turn_'+spriteKey, frames:[{ key:spriteKey, frame:4 }], frameRate:20 });
      this.anims.create({ key:'right_'+spriteKey, frames:this.anims.generateFrameNumbers(spriteKey,{start:5,end:8}), frameRate:10, repeat:-1 });
    }

    this.cursors = this.input.keyboard.createCursorKeys();
    this.keys = this.input.keyboard.addKeys({
      up: Phaser.Input.Keyboard.KeyCodes.W,
      left: Phaser.Input.Keyboard.KeyCodes.A,
      right: Phaser.Input.Keyboard.KeyCodes.D,
      space: Phaser.Input.Keyboard.KeyCodes.SPACE
    });

    // quadro
    this.quadro = this.physics.add.staticSprite(this.quadroPos.x, this.quadroPos.y, 'quadro').setScale(0.9);
    this.physics.add.overlap(this.player, this.quadro, this.coletarQuadro, null, this);

    // texto fase
    this.add.text(16,16,this.mensagem,{ fontSize:'28px', fill:'#000' });

    // inimigos
    this.inimigos = this.physics.add.group();
    this.inimigosCfg.forEach(cfg=>{
      const e = this.inimigos.create(cfg.x, cfg.y, 'enemy1').setScale(2);
      e.setVelocityX(cfg.dir*100);
      this.physics.add.collider(e, this.plataformas);
    });
    this.physics.add.collider(this.player,this.inimigos,this.playerHit,null,this);

    // stomp
    this.playerFoot = this.add.rectangle(this.player.x,this.player.y+this.player.displayHeight/2+10,this.player.displayWidth*0.7,16,0x00ff00,0);
    this.physics.add.existing(this.playerFoot);
    this.playerFoot.body.setAllowGravity(false);
    this.playerFoot.body.setImmovable(true);
    this.physics.add.overlap(this.playerFoot,this.inimigos,this.playerStomp,null,this);

    // === Bot√µes de toque (apenas mobile) ===
    if(isMobile){
      this.touchButtons = {};
      const btnSize = 120;

      this.touchButtons.left = this.add.rectangle(120, 780, btnSize, btnSize, 0x000000, 0.25).setInteractive();
      this.touchButtons.right = this.add.rectangle(280, 780, btnSize, btnSize, 0x000000, 0.25).setInteractive();
      this.touchButtons.jump = this.add.rectangle(1480, 780, btnSize, btnSize, 0x000000, 0.25).setInteractive();

      this.touchState = { left:false, right:false, jump:false };

      this.touchButtons.left.on('pointerdown',()=>this.touchState.left=true);
      this.touchButtons.left.on('pointerup',()=>this.touchState.left=false);
      this.touchButtons.left.on('pointerout',()=>this.touchState.left=false);

      this.touchButtons.right.on('pointerdown',()=>this.touchState.right=true);
      this.touchButtons.right.on('pointerup',()=>this.touchState.right=false);
      this.touchButtons.right.on('pointerout',()=>this.touchState.right=false);

      this.touchButtons.jump.on('pointerdown',()=>this.touchState.jump=true);
      this.touchButtons.jump.on('pointerup',()=>this.touchState.jump=false);
      this.touchButtons.jump.on('pointerout',()=>this.touchState.jump=false);
    }
  }

  update(){
    const spriteKey = personagemSelecionado==='gabriel'?'gabrielSprite':'thainaSprite';

    // inputs teclado ou toque
    const left  = this.cursors.left.isDown || this.keys.left.isDown || (isMobile && this.touchState.left);
    const right = this.cursors.right.isDown || this.keys.right.isDown || (isMobile && this.touchState.right);
    const jump  = this.cursors.up.isDown || this.keys.up.isDown || this.keys.space.isDown || (isMobile && this.touchState.jump);

    if(left){ this.player.setVelocityX(-200); this.player.anims.play('left_'+spriteKey,true); }
    else if(right){ this.player.setVelocityX(200); this.player.anims.play('right_'+spriteKey,true); }
    else { this.player.setVelocityX(0); this.player.anims.play('turn_'+spriteKey); }

    if(jump && this.player.body.blocked.down){ this.player.setVelocityY(-600); }

    this.playerFoot.x=this.player.x;
    this.playerFoot.y=this.player.y+(this.player.displayHeight/2)+10;
    this.playerFoot.body.updateFromGameObject();
  }

  coletarQuadro(){ if(this.proximaFase) this.scene.start(this.proximaFase); else this.scene.start('Menu'); }
  playerHit(){ this.scene.restart(); }
  playerStomp(foot,enemy){ if(this.player.body.velocity.y>0&&enemy.active){ enemy.disableBody(true,true); this.player.setVelocityY(-400); } }
}

/* ===== FASES ===== */
class Fase0 extends BaseFase {
  constructor(){ super("Fase0","Fase1","Fase 0 ‚ù§Ô∏è",[ {x:300,y:760,w:4} ],{x:1180,y:700},[]); }
}
class Fase1 extends BaseFase {
  constructor(){ super("Fase1","Fase2","Fase 1 ‚ù§Ô∏è",[ {x:500,y:720,w:3} ],{x:1260,y:640},[]); }
}
class Fase2 extends BaseFase {
  constructor(){ super("Fase2",null,"Fase 2 ‚ù§Ô∏è",[ {x:600,y:720,w:3} ],{x:1400,y:600},[ {x:800,y:700,dir:-1} ]); }
}

/* CONFIG */
const config = {
  type: Phaser.AUTO,
  width: 1600,
  height: 900,
  pixelArt:true,
  physics: { default:'arcade', arcade:{ gravity:{ y:600 }, debug:false } },
  scale: {
    mode: Phaser.Scale.FIT,
    autoCenter: Phaser.Scale.CENTER_BOTH
  },
  scene: [Menu,EscolhaPersonagem,Fase0,Fase1,Fase2]
};
new Phaser.Game(config);
</script>
</body>
</html>
